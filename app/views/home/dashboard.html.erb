<h1 class="mt-5 text-center">Welcome to Tea Tracker</h1>
<% if current_user %>
<div class="container-fluid py-4">
  <!-- User Profile Section -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <% if current_user.avatar_url.present? %>
            <img src="<%= current_user.avatar_url %>" class="rounded-circle mb-3" alt="Avatar" width="120">
          <% end %>
          <h2 class="mb-1"><%= current_user.username %>'s Tea Collection</h2>
          <p class="text-muted"><%= current_user.bio %></p>

          <div class="d-flex justify-content-center gap-2 mt-3">
            <%= link_to "Add New Tea", new_tea_path, class: "btn btn-success" %>
            <%= link_to "View Collection", teas_path, class: "btn btn-primary" %>
            <%= link_to "Tea Analytics", tea_analytics_path, class: "btn btn-info" %>
            <%= link_to "Logout", logout_path, method: :delete, class: "btn btn-outline-danger" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tea Categories Breakdown -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Tea Categories</h5>
        </div>
        <div class="card-body">
          <% @tea_type_counts.each do |category, count| %>
            <div class="d-flex align-items-center mb-3">
              <div class="me-3 text-end" style="width: 100px;">
                <strong><%= category %></strong>
              </div>
              <div class="progress flex-grow-1" style="height: 25px;">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: <%= (count.to_f / @tea_type_counts.values.sum) * 100 %>%;"
                     aria-valuenow="<%= count %>" aria-valuemin="0" aria-valuemax="<%= @tea_type_counts.values.sum %>">
                  <%= count %> (<%= ((count.to_f / @tea_type_counts.values.sum) * 100).round(1) %>%)
                </div>
              </div>
            </div>
          <% end %>
          <div class="text-end mt-3">
            <%= link_to "View by Category", categories_path, class: "btn btn-sm btn-outline-success" %>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Tea Origins</h5>
        </div>
        <div class="card-body">
          <div class="list-group">
            <% @popular_ship_from.each do |location, count| %>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <i class="bi bi-geo-alt me-2"></i>
                  <%= location %>
                </div>
                <span class="badge bg-primary rounded-pill"><%= count %> teas</span>
              </div>
            <% end %>
          </div>
          <div class="text-end mt-3">
            <%= link_to "View by Origin", origins_path, class: "btn btn-sm btn-outline-primary" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tea Collection Summary -->
  <div class="row mb-4">
    <div class="col-md-12">
      <h3 class="border-bottom pb-2 mb-3">Your Tea Collection at a Glance</h3>
    </div>

    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body text-center">
          <h1 class="display-4 mb-0"><%= @total_teas %></h1>
          <p class="mb-0">Unique Teas</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body text-center">
          <h1 class="display-4 mb-0"><%= @tea_type_counts.keys.count %></h1>
          <p class="mb-0">Tea Categories</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card bg-warning text-white h-100">
        <div class="card-body text-center">
          <h1 class="display-4 mb-0"><%= number_to_currency(@average_tea_cost) %></h1>
          <p class="mb-0">Avg. Cost</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body text-center">
          <h1 class="display-4 mb-0"><%= @popular_ship_from.keys.count %></h1>
          <p class="mb-0">Origins</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tea Highlights -->
  <div class="row mb-4 tea-highlights-row">
    <div class="col-md-12">
      <h3 class="border-bottom pb-2 mb-3">Tea Highlights</h3>
    </div>

    <!-- Top Ranked Tea -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100 tea-highlight-card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Top Ranked Tea</h5>
        </div>
        <div class="card-body d-flex flex-column align-items-center justify-content-between">
          <% if @top_ranked_tea %>
            <div class="text-center mb-3">
              <h4 class="mb-1"><%= @top_ranked_tea.year %> <%= @top_ranked_tea.name %></h4>
              <p class="text-muted mb-3"><%= @top_ranked_tea.category %></p>
            </div>

            <div class="tea-rating my-3">
              <div class="progress mb-2" style="height: 8px; width: 150px;">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: <%= (@top_entry.rank.to_f) %>%;" 
                     aria-valuenow="<%= @top_entry.rank %>" aria-valuemin="0" aria-valuemax="100">
                </div>
              </div>
              <p class="text-center">Rank: <%= @top_entry.rank %>/<%= @total_teas%></p>
            </div>

            <div class="mt-auto">
              <%= link_to "View Details", tea_path(@top_ranked_tea), class: "btn btn-sm btn-outline-secondary" %>
            </div>
          <% else %>
            <p class="text-muted">No ranked teas yet.</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Premium Selection -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100 tea-highlight-card">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Premium Selection</h5>
        </div>
        <div class="card-body d-flex flex-column align-items-center justify-content-between">
          <% if @most_expensive_tea %>
            <div class="text-center mb-3">
              <h4 class="mb-1"><%= @most_expensive_tea.year %> <%= @most_expensive_tea.name %></h4>
              <p class="text-muted mb-3"><%= @most_expensive_tea.category %></p>
            </div>

            <div class="my-3 text-center">
              <h3 class="text-danger mb-2"><%= number_to_currency(@most_expensive_tea.price) %>/g</h3>
              <p class="">From <%= @most_expensive_tea.vendor %></p>
            </div>

            <div class="mt-auto">
              <%= link_to "View Details", tea_path(@most_expensive_tea), class: "btn btn-sm btn-outline-danger" %>
            </div>
          <% else %>
            <p class="text-muted">No teas with a price yet.</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Hidden Gem -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100 tea-highlight-card">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Hidden Gem</h5>
        </div>
        <div class="card-body d-flex flex-column align-items-center justify-content-between">
          <% if @least_popular_tea %>
            <div class="text-center mb-3">
              <h4 class="mb-1"><%= @least_popular_tea.year %> <%= @least_popular_tea.name %></h4>
              <p class="text-muted mb-3"><%= @least_popular_tea.category %></p>
            </div>

            <div class="my-3">
              <div class="progress mb-2" style="height: 8px; width: 150px;">
                <div class="progress-bar bg-dark" role="progressbar"
                     style="width: <%= (@least_popular_tea.popularity.to_f) %>%;" 
                     aria-valuenow="<%= @least_popular_tea.popularity %>" aria-valuemin="0" aria-valuemax="100">
                </div>
              </div>
              <p class="text-center">Popularity: <%= @least_popular_tea.popularity %>/<%= @total_teas%></p>
              <p class="small text-center">Vendor: <%= @least_popular_tea.vendor %></p>
            </div>

            <div class="mt-auto">
              <%= link_to "View Details", tea_path(@least_popular_tea), class: "btn btn-sm btn-outline-dark" %>
            </div>
          <% else %>
            <p class="text-muted">No teas with a popularity score yet.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Tea Stats -->
  <div class="row mb-4">

    <div class="col-md-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Most Expensive Tea</h5>
        </div>
        <div class="card-body">
          <% most_expensive = @teas.order(price: :desc).first %>
          <% if most_expensive %>
            <h4 class="mb-2"><%= most_expensive.name %></h4>
            <p class="text-muted mb-3"><%= most_expensive.category %></p>
            <h3 class="text-success mb-0">
              <%= number_to_currency(most_expensive.price) %>
            </h3>
          <% else %>
            <p class="text-muted">No teas available</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Least Popular Tea</h5>
        </div>
        <div class="card-body">
          <% least_popular = @teas.order(popularity: :asc).first %>
          <% if least_popular %>
            <h4 class="mb-2"><%= least_popular.name %></h4>
            <p class="text-muted mb-3"><%= least_popular.category %></p>
            <div class="progress mb-2" style="height: 8px; width: 150px; margin: 0 auto;">
              <div class="progress-bar bg-primary" role="progressbar"
                   style="width: <%= (least_popular.popularity.to_f) %>%;" 
                   aria-valuenow="<%= least_popular.popularity %>" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <p>Popularity Score: <%= least_popular.popularity %>/<%= @total_teas%></p>
          <% else %>
            <p class="text-muted">No teas available</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

<!-- === Your Price Distribution ================================ -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0">Your Price Distribution</h5>
  </div>

  <div class="card-body p-3">
    <div class="row">
      <div class="col-md-8">
    <div class="mb-3">
      <!-- category picker -->
      <label for="categorySelect" class="form-label me-2">Select a Tea Category:</label>
      <select id="categorySelect" class="form-select form-select-sm d-inline-block" style="width:auto;">
         <option value=""   selected>All</option>
        <% @tea_categories.each do |category| %>
          <option value="<%= category %>"><%= category %></option>
        <% end %>
      </select>

      <!-- color picker -->
      <label for="colorSelect" class="form-label me-2">Color:</label>
      <select id="colorSelect" class="form-select form-select-sm d-inline-block" style="width:auto;">
        <option value="pink"   selected>Pink</option>
        <option value="green">Green</option>
        <option value="blue">Blue</option>
        <option value="yellow">Yellow</option>
      </select>
    </div>
    <div class="border rounded p-3" style="height:400px;">
      <canvas id="priceChart" style="width:100%;height:100%;"></canvas>
    </div>
      </div>
        <div class="col-md-4">
          <%= render partial: 'price_statistics' %>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-4 mb-5">
    <%= link_to "View All Teas", teas_path, class: "btn btn-primary btn-lg px-4" %>
  </div>
</div>

<% else %>
  <p class="text-center">
    <%= link_to "Login", new_session_path %> or
    <%= link_to "Sign Up", new_user_path %> to get started tracking your teas.
  </p>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const teaData = <%= @user_teas.to_json.html_safe %>; // [["Name", price, grams]]
  if (!teaData.length) return;

  let mode = 'perGram';
  let selectedColor = 'pink';
  let selectedCategory = '';

  function getPriceValue(price, grams) {
    return parseFloat(price); // Just use the raw price, no need to divide by grams
  }

  function getHistogramData() {
    const data = selectedCategory !== '' 
    ? teaData.filter(item => item[3] === selectedCategory) 
    : teaData;
    const values = data.map(([_, price, grams, category]) => getPriceValue(price, grams)).filter(v => v !== null);

    const binSize = 0.1;
    const min = 0;
    const max = Math.max(...values);
    const roundedMax = Math.ceil(max); // for axis

    const bins = [];
    const binCounts = [];

    for (let b = min; b < roundedMax; b += binSize) {
      bins.push(b + binSize / 2); // bin center
      binCounts.push(0);
    }

    data.forEach(([_, price, grams]) => {
      const val = getPriceValue(price, grams);
      if (val === null) return;
      const i = Math.floor((val - min) / binSize);
      if (i >= 0 && i < binCounts.length) {
        binCounts[i]++;
      }
    });

    const histogramData = bins.map((x, i) => ({
      x,
      y: binCounts[i]
    }));

    return { histogramData, bins, binSize, values, roundedMax };
  }

  function getSmoothedLine(values, minX, maxX, resolution = 200) {
    const kernel = x => {
      const bw = 0.05;
      return values.reduce((sum, v) => {
        const z = (x - v) / bw;
        return sum + Math.exp(-0.5 * z * z);
      }, 0) / (values.length * bw * Math.sqrt(2 * Math.PI));
    };

    const xPoints = [], yPoints = [];
    for (let i = 0; i < resolution; i++) {
      const x = minX + ((maxX - minX) * i) / (resolution - 1);
      xPoints.push(x);
      yPoints.push(kernel(x));
    }

    const yMax = Math.max(...yPoints);
    const scaledY = yPoints.map(y => y * (10 / yMax)); // scale to match bar height

    return xPoints.map((x, i) => ({ x, y: scaledY[i] }));
  }

  const pastels = {
    pink: 'rgba(255,179,198,0.6)',
    green: 'rgba(181,234,215,0.6)',
    blue: 'rgba(179,199,255,0.6)',
    yellow: 'rgba(255,241,179,0.6)'
  };

  const ctx = document.getElementById('priceChart').getContext('2d');
  let chart;

  function renderChart() {
    const { histogramData, bins, binSize, values, roundedMax } = getHistogramData();
    const maxY = Math.ceil(Math.max(...histogramData.map(d => d.y)) / 5) * 5;

    const datasets = [{
      type: 'bar',
      data: histogramData,
      backgroundColor: pastels[selectedColor],
      borderColor: pastels[selectedColor].replace('0.6', '1'),
      borderWidth: 1,
      barPercentage: 1.0,
      categoryPercentage: 1.0
    }];

    const smooth = getSmoothedLine(values, 0, roundedMax);
    datasets.push({
      type: 'line',
      data: smooth,
      borderColor: pastels[selectedColor].replace('0.6', '1'),
      borderWidth: 2,
      fill: false,
      tension: 0.4,
      pointRadius: 0,
      order: 1
    });

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: 'bar',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        },
        scales: {
          x: {
            type: 'linear',
            min: 0,
            max: roundedMax,
            offset: false,
            title: {
              display: true,
              text: 'Price per Gram ($/g)'
            },
            ticks: {
              stepSize: 0.10,
              callback: val => `$${val.toFixed(2)}`
            },
            grid: {
              drawTicks: true,
              drawOnChartArea: true,
              tickLength: 8,
              borderDash: []
            }
          },
          y: {
            beginAtZero: true,
            suggestedMax: maxY,
            title: {
              display: true,
              text: 'Number of Teas'
            },
            ticks: {
              stepSize: 5,
              callback: val => val
            }
          }
        }
      }
    });
  }

  document.getElementById('colorSelect').addEventListener('change', e => {
    selectedColor = e.target.value;
    renderChart();
  });

  document.getElementById('categorySelect').addEventListener('change', e => {
    selectedCategory = e.target.value;
    renderChart();
  });

  // ✅ Initial render on page load
  renderChart();
});
</script>
